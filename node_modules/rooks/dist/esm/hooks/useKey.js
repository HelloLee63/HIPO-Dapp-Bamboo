import { useMemo, useRef, useEffect, useCallback } from 'react';
import { doesIdentifierMatchKeyboardEvent } from '../utils/doesIdentifierMatchKeyboardEvent.js';
import { noop } from '../utils/noop.js';

const defaultOptions = {
    eventTypes: ["keydown"],
    when: true,
};
/**
 * useKey hook
 *
 * Fires a callback on keyboard events like keyDown, keyPress and keyUp
 *
 * @param {TrackedKeyEvents} keys List of keys to listen for. Eg: ["a", "b"]
 * @param {Callback} callback  Callback to fire on keyboard events
 * @param {Options} options Options
 * @see https://rooks.vercel.app/docs/useKey
 */
function useKey(keys, callback, options) {
    const keyList = useMemo(() => {
        if (Array.isArray(keys)) {
            return keys;
        }
        else {
            return [keys];
        }
    }, [keys]);
    const internalOptions = useMemo(() => {
        return Object.assign(Object.assign({}, defaultOptions), options);
    }, [options]);
    const { when, eventTypes } = internalOptions;
    const callbackRef = useRef(callback);
    const { target } = internalOptions;
    useEffect(() => {
        callbackRef.current = callback;
    });
    const handle = useCallback((event) => {
        if (keyList.some((identifier) => doesIdentifierMatchKeyboardEvent(event, identifier))) {
            callbackRef.current(event);
        }
    }, [keyList]);
    useEffect(() => {
        if (when && typeof window !== "undefined") {
            // If target is defined by the user
            if (target) {
                const targetNode = target.current;
                if (targetNode) {
                    for (const eventType of eventTypes) {
                        targetNode.addEventListener(eventType, handle);
                    }
                    return () => {
                        for (const eventType of eventTypes) {
                            targetNode.removeEventListener(eventType, handle);
                        }
                    };
                }
            }
            else {
                for (const eventType of eventTypes) {
                    window.addEventListener(eventType, handle);
                }
                return () => {
                    for (const eventType of eventTypes) {
                        window.removeEventListener(eventType, handle);
                    }
                };
            }
        }
        return noop;
    }, [when, eventTypes, keyList, target, callback, handle]);
}

export { useKey };
